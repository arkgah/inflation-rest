create table person_role
(
    id   int primary key generated by default as identity,
    name varchar(50) not null
);

create table person
(
    id          int primary key generated by default as identity,
    login       varchar(100) not null unique,
    password    varchar(255) not null,
    first_name  varchar(50)  not null,
    last_name   varchar(50)  not null,
    role_id     int          references person_role (id) on delete set null,
    external_id varchar(30)  not null unique
);

create table store
(
    id          int primary key generated by default as identity,
    name        varchar(100) not null unique check (length(name) >= 2),
    external_id varchar(30)  not null unique
);

create table product_category
(
    id          int primary key generated by default as identity,
    name        varchar(100) not null unique,
    external_id varchar(30)  not null unique
);

create table product
(
    id          int primary key generated by default as identity,
    name        varchar(100) not null,
    category_id int          references product_category (id) on delete set null,
    unit        float8       not null check ( unit > 0),
    external_id varchar(30)  not null unique,
    unique (name, category_id)
);

create table purchase
(
    id           int primary key generated by default as identity,
    price        money       not null check (price > money(0)),
    purchased_at date        not null,
    product_id   int         references product (id) on delete set null,
    store_id     int         references store (id) on delete set null,
    memo         varchar(200),
    person_id    int         references person (id) on delete set null,
    external_id  varchar(30) not null unique
);